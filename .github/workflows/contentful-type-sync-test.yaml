name: contentful-type-sync-test
on:
  repository_dispatch:
    types: [contentful-sync]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "14"

      - name: Log repository_dispatch payload
        run: |
          echo "Received repository_dispatch event"
          echo "Event type: ${{ github.event.action }}"
          echo "Client payload: ${{ toJson(github.event.client_payload) }}"

      - name: Run server to log POST request
        run: |
          nohup node server.js > server.log 2>&1 &
          echo "Server is running..."
          sleep 5  # Give the server some time to start

      - name: Send repository_dispatch payload to server
        run: |
          curl -X POST http://localhost:8000 -H "Content-Type: application/json" -d '${{ toJson(github.event.client_payload) }}'

      - name: Display server logs
        run: cat server.log
